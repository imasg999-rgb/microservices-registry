<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Live Flight Tracker</title>
        <link rel="stylesheet" href="styles.css" />
    </head>
    <body>
        <div class="container">
            <header>
                <h1><a href="">‚úàÔ∏è Live Flight Tracker</a></h1>
                <p class="subtitle">
                    Real-time flight information near Western University
                </p>
            </header>

            <div class="search-section">
                <form id="flightForm" class="search-form">
                    <input
                        type="text"
                        id="flightNumber"
                        placeholder="Enter callsign (e.g., ACA787)"
                        required
                    />
                    <button type="submit">Search</button>
                </form>
            </div>

            <div id="defaultFlightsSection">
                <h2 class="section-title">Nearby Flights (50km radius)</h2>
                <div id="defaultFlights" class="flights-grid"></div>
            </div>

            <div id="searchResultsSection" style="display: none">
                <h2 class="section-title">Search Results</h2>
                <div id="searchResults"></div>
            </div>
        </div>

        <script>
            // Get the DOM elements
            const form = document.getElementById('flightForm');
            const flightNumberInput = document.getElementById('flightNumber');
            const defaultFlightsDiv = document.getElementById('defaultFlights');
            const searchResultsDiv = document.getElementById('searchResults');
            const defaultSection = document.getElementById(
                'defaultFlightsSection'
            );
            const searchSection = document.getElementById(
                'searchResultsSection'
            );

            // Load nearby flights on page load
            window.addEventListener('load', () => {
                loadNearbyFlights();
            });

            async function loadNearbyFlights() {
                defaultFlightsDiv.innerHTML =
                    '<div class="loading">Loading nearby flights...</div>';

                try {
                    const res = await fetch('/api/nearby');
                    const data = await res.json();

                    if (data.error) {
                        defaultFlightsDiv.innerHTML = `<div class="error">${data.error}</div>`;
                        return;
                    }

                    if (data.count === 0) {
                        defaultFlightsDiv.innerHTML =
                            '<div class="no-results">No flights currently in the area</div>';
                        return;
                    }

                    defaultFlightsDiv.innerHTML = '';
                    // Show up to 6 flights
                    data.results.slice(0, 6).forEach((flight) => {
                        defaultFlightsDiv.appendChild(createFlightCard(flight));
                    });
                } catch (err) {
                    defaultFlightsDiv.innerHTML = `<div class="error">Error loading flights: ${err.message}</div>`;
                }
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const callsign = flightNumberInput.value.trim().toUpperCase();
                searchResultsDiv.innerHTML =
                    '<div class="loading">Searching for flight...</div>';

                defaultSection.style.display = 'none';
                searchSection.style.display = 'block';

                try {
                    const res = await fetch(
                        `/api/flight?flight=${encodeURIComponent(callsign)}`
                    );
                    const data = await res.json();

                    if (data.error) {
                        searchResultsDiv.innerHTML = `<div class="error">${data.error}</div>`;
                        return;
                    }

                    if (data.count === 0) {
                        searchResultsDiv.innerHTML = `
                            <div class="no-results">
                                No flights found matching "${callsign}"<br>
                                <small style="color: #999;">Try searching for: ACA787, WJA123, etc.</small>
                            </div>
                        `;
                        return;
                    }

                    searchResultsDiv.innerHTML = '';
                    const grid = document.createElement('div');
                    grid.className = 'flights-grid';

                    data.results.forEach((flight) => {
                        grid.appendChild(createFlightCard(flight));
                    });

                    searchResultsDiv.appendChild(grid);
                } catch (err) {
                    searchResultsDiv.innerHTML = `<div class="error">Error: ${err.message}</div>`;
                }
            });

            function createFlightCard(flight) {
                const card = document.createElement('div');
                card.className = 'flight-card';

                // Extract data from ADSB.lol format
                const callsign = flight.flight
                    ? flight.flight.trim()
                    : flight.hex || 'Unknown';
                const registration = flight.r || 'N/A';
                const aircraftType = flight.t || 'N/A';
                const altitude = flight.alt_baro
                    ? flight.alt_baro + ' ft'
                    : flight.alt_geom
                    ? flight.alt_geom + ' ft'
                    : 'N/A';
                const groundSpeed = flight.gs
                    ? Math.round(flight.gs) + ' kts'
                    : 'N/A';
                const track = flight.track
                    ? Math.round(flight.track) + '¬∞'
                    : 'N/A';
                const latitude =
                    flight.lat !== undefined ? flight.lat.toFixed(4) : 'N/A';
                const longitude =
                    flight.lon !== undefined ? flight.lon.toFixed(4) : 'N/A';
                const verticalRate =
                    flight.baro_rate !== undefined && flight.baro_rate !== null
                        ? (flight.baro_rate > 0
                              ? '‚Üë '
                              : flight.baro_rate < 0
                              ? '‚Üì '
                              : '') +
                          Math.abs(Math.round(flight.baro_rate)) +
                          ' ft/min'
                        : 'N/A';
                const squawk = flight.squawk || 'N/A';

                // Determine if on ground (some aircraft don't report this)
                const onGround =
                    flight.alt_baro === 'ground' ||
                    (flight.alt_baro !== undefined && flight.alt_baro < 100);

                card.innerHTML = `
                    <div class="flight-header">
                        <div class="callsign">${callsign}</div>
                        <div class="status-badge ${
                            onGround ? 'status-ground' : 'status-airborne'
                        }">
                            ${onGround ? 'üõ¨ On Ground' : '‚úàÔ∏è Airborne'}
                        </div>
                    </div>
                    <div class="flight-detail">
                        <span class="detail-label">Registration</span>
                        <span class="detail-value">${registration}</span>
                    </div>
                    <div class="flight-detail">
                        <span class="detail-label">Aircraft Type</span>
                        <span class="detail-value">${aircraftType}</span>
                    </div>
                    <div class="flight-detail">
                        <span class="detail-label">Altitude</span>
                        <span class="detail-value">${altitude}</span>
                    </div>
                    <div class="flight-detail">
                        <span class="detail-label">Ground Speed</span>
                        <span class="detail-value">${groundSpeed}</span>
                    </div>
                    <div class="flight-detail">
                        <span class="detail-label">Track</span>
                        <span class="detail-value">${track}</span>
                    </div>
                    <div class="flight-detail">
                        <span class="detail-label">Vertical Rate</span>
                        <span class="detail-value">${verticalRate}</span>
                    </div>
                    <div class="flight-detail">
                        <span class="detail-label">Squawk</span>
                        <span class="detail-value">${squawk}</span>
                    </div>
                    <div class="flight-detail">
                        <span class="detail-label">Position</span>
                        <span class="detail-value coords">${latitude}, ${longitude}</span>
                    </div>
                `;

                return card;
            }
        </script>
    </body>
</html>
